<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Øª Firebase Phone Auth - Snabb</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
        }
        
        h1 {
            text-align: center;
            color: #1f2937;
            margin-bottom: 10px;
            font-size: 32px;
        }
        
        .subtitle {
            text-align: center;
            color: #6b7280;
            margin-bottom: 30px;
        }
        
        .step {
            background: #f3f4f6;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .step h2 {
            color: #059669;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 600;
        }
        
        input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            direction: ltr;
            text-align: center;
        }
        
        input:focus {
            outline: none;
            border-color: #10b981;
        }
        
        button {
            width: 100%;
            padding: 15px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }
        
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        
        .hidden {
            display: none;
        }
        
        .success {
            background: #d1fae5;
            border: 2px solid #10b981;
            color: #065f46;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
        }
        
        .error {
            background: #fee2e2;
            border: 2px solid #ef4444;
            color: #991b1b;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
        }
        
        .info {
            background: #dbeafe;
            border: 2px solid #3b82f6;
            color: #1e40af;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .info strong {
            display: block;
            margin-bottom: 8px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #10b981;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .back-link {
            text-align: center;
            margin-top: 20px;
        }
        
        .back-link a {
            color: #10b981;
            text-decoration: none;
            font-weight: 600;
        }
        
        .back-link a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš• ØªØ³Øª Snabb Phone Auth</h1>
        <p class="subtitle">Ø³ÛŒØ³ØªÙ… ÙˆØ±ÙˆØ¯ Ø¨Ø§ Firebase</p>
        
        <!-- Step 1: Phone Number -->
        <div id="step1" class="step">
            <h2>Ù…Ø±Ø­Ù„Ù‡ 1: ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†</h2>
            
            <div class="info">
                <strong>Ø´Ù…Ø§Ø±Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ³ØªÛŒ Firebase:</strong>
                â€¢ +93 79 912 3456 â†’ Ú©Ø¯: 123456<br>
                â€¢ +93 79 910 1112 â†’ Ú©Ø¯: 123456<br>
                â€¢ +93 79 856 7909 â†’ Ú©Ø¯: 123456
            </div>
            
            <div class="form-group">
                <label>Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†:</label>
                <input 
                    type="tel" 
                    id="phoneInput" 
                    placeholder="+93799123456 ÛŒØ§ 0799123456"
                    maxlength="20"
                >
            </div>
            
            <button id="sendOtpBtn">Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯ ØªØ£ÛŒÛŒØ¯</button>
            
            <div id="recaptcha-container"></div>
        </div>
        
        <!-- Step 2: OTP Verification -->
        <div id="step2" class="step hidden">
            <h2>Ù…Ø±Ø­Ù„Ù‡ 2: ØªØ£ÛŒÛŒØ¯ Ú©Ø¯ OTP</h2>
            
            <div class="info">
                Ú©Ø¯ 6 Ø±Ù‚Ù…ÛŒ ØªØ£ÛŒÛŒØ¯ Ø¨Ù‡ Ø´Ù…Ø§Ø±Ù‡ <strong id="sentToPhone"></strong> Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯.
                <br>
                Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§Ø±Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ³ØªÛŒØŒ Ú©Ø¯ Ù‡Ù…ÛŒØ´Ù‡ <strong>123456</strong> Ø§Ø³Øª.
            </div>
            
            <div class="form-group">
                <label>Ú©Ø¯ ØªØ£ÛŒÛŒØ¯ (6 Ø±Ù‚Ù…ÛŒ):</label>
                <input 
                    type="text" 
                    id="otpInput" 
                    placeholder="123456"
                    maxlength="6"
                    pattern="[0-9]{6}"
                >
            </div>
            
            <button id="verifyOtpBtn">ØªØ£ÛŒÛŒØ¯ Ùˆ ÙˆØ±ÙˆØ¯</button>
            
            <button id="changeNumberBtn" style="background: #6b7280; margin-top: 10px;">
                ØªØºÛŒÛŒØ± Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†
            </button>
        </div>
        
        <!-- Success Message -->
        <div id="successMessage" class="success hidden">
            âœ… ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯!<br>
            <strong>Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ† Ø´Ù…Ø§: <span id="userPhone"></span></strong>
        </div>
        
        <!-- Error Message -->
        <div id="errorMessage" class="error hidden"></div>
        
        <!-- Loading -->
        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <p style="margin-top: 15px; color: #6b7280;">Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...</p>
        </div>
        
        <div class="back-link">
            <a href="/login">â† Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ Login Ø§ØµÙ„ÛŒ</a>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            RecaptchaVerifier, 
            signInWithPhoneNumber 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBqWEmIIngkoEjiAUKAcT3rvQGtsvCj3qc",
            authDomain: "snabb-82415.firebaseapp.com",
            projectId: "snabb-82415",
            storageBucket: "snabb-82415.firebasestorage.app",
            messagingSenderId: "1006448447805",
            appId: "1:1006448447805:web:c58b45899bcd67aa5d7554",
            measurementId: "G-V2JM77CH43"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // Global variables
        let confirmationResult = null;
        let recaptchaVerifier = null;

        // DOM elements
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const phoneInput = document.getElementById('phoneInput');
        const otpInput = document.getElementById('otpInput');
        const sendOtpBtn = document.getElementById('sendOtpBtn');
        const verifyOtpBtn = document.getElementById('verifyOtpBtn');
        const changeNumberBtn = document.getElementById('changeNumberBtn');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        const loading = document.getElementById('loading');
        const sentToPhone = document.getElementById('sentToPhone');
        const userPhone = document.getElementById('userPhone');

        // Setup reCAPTCHA
        function setupRecaptcha() {
            if (!recaptchaVerifier) {
                recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
                    'size': 'invisible',
                    'callback': (response) => {
                        console.log('reCAPTCHA solved');
                    },
                    'expired-callback': () => {
                        console.log('reCAPTCHA expired');
                        showError('reCAPTCHA Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.');
                    }
                });
            }
        }

        // Show/Hide functions
        function showLoading() {
            loading.classList.remove('hidden');
        }

        function hideLoading() {
            loading.classList.add('hidden');
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            setTimeout(() => {
                errorMessage.classList.add('hidden');
            }, 5000);
        }

        function showSuccess() {
            successMessage.classList.remove('hidden');
            step1.classList.add('hidden');
            step2.classList.add('hidden');
        }

        // Format phone number
        function formatPhoneNumber(phone) {
            let formatted = phone.trim();
            if (!formatted.startsWith('+')) {
                formatted = '+93' + formatted.replace(/^0+/, '');
            }
            return formatted;
        }

        // Send OTP
        sendOtpBtn.addEventListener('click', async () => {
            const phone = phoneInput.value;
            
            if (!phone) {
                showError('Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }

            try {
                showLoading();
                errorMessage.classList.add('hidden');
                
                const formattedPhone = formatPhoneNumber(phone);
                console.log('Sending OTP to:', formattedPhone);
                
                setupRecaptcha();
                
                confirmationResult = await signInWithPhoneNumber(auth, formattedPhone, recaptchaVerifier);
                
                hideLoading();
                step1.classList.add('hidden');
                step2.classList.remove('hidden');
                sentToPhone.textContent = formattedPhone;
                
                console.log('OTP sent successfully');
            } catch (error) {
                hideLoading();
                console.error('Error sending OTP:', error);
                showError('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯: ' + error.message);
                
                // Reset recaptcha
                if (recaptchaVerifier) {
                    recaptchaVerifier.clear();
                    recaptchaVerifier = null;
                }
            }
        });

        // Verify OTP
        verifyOtpBtn.addEventListener('click', async () => {
            const otp = otpInput.value;
            
            if (!otp || otp.length !== 6) {
                showError('Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ 6 Ø±Ù‚Ù…ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }

            try {
                showLoading();
                errorMessage.classList.add('hidden');
                
                const result = await confirmationResult.confirm(otp);
                const user = result.user;
                
                hideLoading();
                
                console.log('Login successful:', user);
                userPhone.textContent = user.phoneNumber;
                showSuccess();
                
            } catch (error) {
                hideLoading();
                console.error('Error verifying OTP:', error);
                showError('Ú©Ø¯ ØªØ£ÛŒÛŒØ¯ Ù†Ø§Ø¯Ø±Ø³Øª Ø§Ø³Øª');
            }
        });

        // Change number
        changeNumberBtn.addEventListener('click', () => {
            step2.classList.add('hidden');
            step1.classList.remove('hidden');
            otpInput.value = '';
            errorMessage.classList.add('hidden');
        });

        // Enter key support
        phoneInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendOtpBtn.click();
            }
        });

        otpInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                verifyOtpBtn.click();
            }
        });
    </script>
</body>
</html>
